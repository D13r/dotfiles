#!/bin/bash

source ~/.bash/colors.sh

header()
{
    echo
    green bold "$1"
}

list_aws() {
    aws codecommit list-repositories --region eu-west-1 --output json | \
        jq -r '.repositories | map("git clone APKAI4DDXFNM364TWXJA@git-codecommit.eu-west-1.amazonaws.com:v1/repos/\(.repositoryName)") | .[]' | \
        sort
}

list_github()
{
    token="$(python -c 'import sys, yaml, json; json.dump(yaml.load(sys.stdin), sys.stdout, indent=4)' < ~/.config/hub | jq -r '.["github.com"][0].oauth_token')"

    http -b get https://api.github.com/user/repos?per_page=100 "Accept: application/vnd.github.v3+json" "Authorization: token $token" | \
        jq -r 'map("git clone \(.ssh_url)") | .[]' | \
        sort
}

list_gitlab()
{
    token="$(json2hcl -reverse < ~/.config/lab.hcl | jq -r '.core[0].token')"

    http -b get "https://gitlab.com/api/v4/projects?owned=1&simple=1&per_page=100" "Private-Token: $token" | \
        jq -r 'map("git clone \(.ssh_url_to_repo)") | .[]' | \
        sort
}

service="${1:-}"

if [ "$service" = "all" ]; then

    header "AWS CodeCommit"
    list_aws

    header "GitHub"
    list_github

    header "GitLab"
    list_gitlab

elif [ "$service" = "aws" ]; then

    list_aws

elif [ "$service" = "github" ] || [ "$service" = "hub" ] || [ "$service" = "gh" ]; then

    list_github

elif [ "$service" = "gitlab" ] || [ "$service" = "lab" ] || [ "$service" = "gl" ]; then

    list_gitlab

else

    echo "Usage: $(basename $0) <aws|hub|lab|all>"

fi
