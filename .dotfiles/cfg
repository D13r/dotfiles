#!/bin/bash

#================================================================================
# USAGE:
# wget djm.me/cfg
# . cfg
#================================================================================

# Run this in a sub-process
(
    set -o errexit -o pipefail -o nounset

    # Should be in home directory anyway, but just in case...
    cd

    # WSL defaults to umask 000
    umask 022

    # Helpers
    say() {
        echo -en "\e[94m" # Light blue
        echo -n "$1"
        echo -e "\e[0m"
    }

    fail() {
        echo >&2 -en "\e[91m" # Light red
        echo >&2 -n "$1"
        echo >&2 -e "\e[0m"
        exit 1
    }

    # Sanity checks
    [ -f cfg ] || fail 'This script must be named ~/cfg'
    [ -d .git ] && fail '~/.git already exists'

    # Check git is available
    if ! command -v git >/dev/null; then
        # Attempt to install it if not
        say 'Installing Git'
        if ! (sudo apt-get update && sudo apt-get install -y git); then
            fail 'Git could not be installed'
        fi
    fi

    # Download the repository
    say 'Downloading dotfiles repository'
    git init || fail 'Failed to initialise the Git repo'
    git remote add origin 'https://davejamesmiller.com/dave/dotfiles.git' || fail 'Failed to add the Git origin'
    git remote set-url --push origin 'git@djm.me:dave/dotfiles.git' || fail 'Failed to configure the Git origin push URL'
    git fetch --depth=1 origin || fail 'Failed to download the Git repository'

    # Check out the files
    say 'Checking out files'
    git checkout -f origin/master -b master

    # Remove this script
    # (Note: $0 is not set because we 'source' this file)
    say "Removing the 'cfg' bootstrap script"
    rm -f cfg

    # Run any post-install commands, e.g. prepare config file
    say 'Running post-install script'
) && exec ~/.dotfiles/post-install
