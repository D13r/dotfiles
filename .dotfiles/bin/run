#!/usr/bin/env bash
set -euo pipefail
cd "$(dirname "$0")/.."

opt=()
if [[ -n $SSH_AUTH_SOCK ]]; then
    opt=(--volume $SSH_AUTH_SOCK:/tmp/ssh-agent --env SSH_AUTH_SOCK=/tmp/ssh-agent)
fi

tmux=true
user=test
while [[ $# -gt 0 ]]; do
    case "$1" in
        -d | --debug)
            tmux=false
            ;;
        -r | --root)
            user=root
            ;;
        *)
            break;
    esac

    shift
done

bin/_build "$@"

if $tmux; then
    exec maybe-sudo-for-docker docker run "${opt[@]}" -it --rm --entrypoint /usr/bin/tmux -u "$user" dotfiles -2 new -A -s "$user"
else
    exec maybe-sudo-for-docker docker run "${opt[@]}" -it --rm dotfiles
fi

