Include config_local

#---------------------------------------
# Hosts in the menu
#---------------------------------------

# Lines starting with "##|" are used in ~/.bin/terminal-menu

##| djm.me | k | kara | Development VM on Chell
Host k kara kara.djm.me
    Hostname kara.djm.me
    User dave
    ForwardX11 yes

##| djm.me | m | maria | Desktop PC
Host m maria maria.djm.me
    Hostname maria.djm.me
    User dave
    ForwardX11 yes

##| djm.me | 7& | seven | Production VM (Hetzner)
Host 7 seven seven.djm.me
    Hostname seven.djm.me
    User dave

##| maths.ox.ac.uk | b | beulah-penguin | Desktop PC
Host b bp beulah-penguin beulah-penguin.maths.ox.ac.uk
    Hostname beulah-penguin.maths.ox.ac.uk
    User miller
    ForwardX11 yes

# Automatically wake my desktop when needed, at the expense of a slightly slower connection when it is already awake
Match final host beulah-penguin.maths.ox.ac.uk exec "wake beulah-penguin"

##| maths.ox.ac.uk | s | syndrome | General purpose shared server
Host s syndrome syndrome.maths.ox.ac.uk
    Hostname syndrome.maths.ox.ac.uk
    User miller
    ForwardX11 yes

##| maths.ox.ac.uk | t | trent-bridge | Main website - staging
Host t tb trent-bridge trent-bridge.maths.ox.ac.uk
    Hostname trent-bridge.maths.ox.ac.uk

##| maths.ox.ac.uk | d | webdev | Development VM
Host d webdev webdev.maths.ox.ac.uk
    Hostname webdev.maths.ox.ac.uk
    ForwardX11 yes

##| maths.ox.ac.uk | w | www | Main website - live
Host w www www.maths.ox.ac.uk
    # Doesn't allow IPv6 connections yet (Apr 2023)
    AddressFamily inet
    # Using the service IP doesn't currently work via gate, presumably because of IPv6 again (May 2023)
    # When it does work, update the port forwarding below too
    Hostname trimpot.maths.ox.ac.uk

# This is a special case, so doesn't have the usual menu config here
Host l lh localhost
    Hostname localhost
    # Maths servers don't allow IPv6 connections yet, but 'localhost' defaults to ::1 (Apr 2023)
    AddressFamily inet
    ForwardAgent yes
    ForwardX11 yes
    IdentitiesOnly no

#---------------------------------------
# Hosts not in the menu
#---------------------------------------

Host boot boot.djm.me
    Hostname boot.djm.me
    User dave
    ForwardX11 yes

Host bl
    Hostname bramall-lane.maths.ox.ac.uk

Host ddp daydreamerphotos.com
    Hostname daydreamerphotos.com
    User daydream
    ForwardAgent yes

Host door
    Hostname door-entry.maths.ox.ac.uk

Host gate gate.maths.ox.ac.uk
    Hostname gate.maths.ox.ac.uk
    User miller
    ForwardX11 yes

Host mddp my.daydreamerphotos.com
    Hostname my.daydreamerphotos.com
    User mydaydre
    ForwardAgent yes

Host pi pi.djm.me
    Hostname pi.djm.me
    User pi
    ForwardX11 yes

#---------------------------------------
# Port forwarding
#---------------------------------------

# DBeaver - https://github.com/dbeaver/dbeaver/issues/10273
# Can't use a Before Connect script inside Snap because it can't find the 'ssh' executable or the SSH agent socket
Match final host edgbaston.maths.ox.ac.uk exec "[[ $HOSTNAME = 'beulah-penguin.maths.ox.ac.uk' || $HOSTNAME = 'Chell' ]]"
    LocalForward 33060 /run/mysqld/mysqld.sock

Match final host cmi.maths.ox.ac.uk exec "[[ $HOSTNAME = 'beulah-penguin.maths.ox.ac.uk' || $HOSTNAME = 'Chell' ]]"
    LocalForward 33061 /run/mysqld/mysqld.sock

Match final host trimpot.maths.ox.ac.uk exec "[[ $HOSTNAME = 'Chell' ]]"
    LocalForward 33062 /run/mysqld/mysqld.sock

Match final host door-entry.maths.ox.ac.uk exec "[[ $HOSTNAME = 'Chell' ]]"
    LocalForward 33063 /run/mysqld/mysqld.sock

Match final host db0.maths.ox.ac.uk exec "[[ $HOSTNAME = 'Chell' ]]"
    LocalForward 33064 /run/mysqld/mysqld.sock

Match final host door-entry.maths.ox.ac.uk exec "[[ $HOSTNAME = 'beulah-penguin.maths.ox.ac.uk' || $HOSTNAME = 'Chell' ]]"
    LocalForward 49431 motor.security:49431

# SOCKS proxy for internal websites (to use with FoxyProxy Standard)
Match final host beulah-penguin.maths.ox.ac.uk exec "[[ $HOSTNAME = 'Chell' ]]"
    DynamicForward 1080

#---------------------------------------
# Host groups
#---------------------------------------

# These use "Match final" to match hostnames after canonicalisation, allowing
# me to use short hostnames without specifying every possible hostname here
Match final host *.djm.me
    ForwardAgent yes

Match final host *.maths.ox.ac.uk
    ForwardAgent yes
    IdentityFile ~/.ssh/mi-dave.pub

Match final host *.maths.ox.ac.uk !host gate.maths.ox.ac.uk exec "[[ $HOSTNAME != *.maths.ox.ac.uk ]]"
    ProxyJump gate

#---------------------------------------
# Defaults
#---------------------------------------

Host *
    CanonicalDomains maths.ox.ac.uk djm.me
    CanonicalizeHostname yes
    Compression yes
    ForwardX11 no
    ServerAliveInterval 15
    UpdateHostKeys yes

    # It is more common for me to be connecting as 'root' than as whatever
    # username I happen to be logged into right now, so make that the default
    User root

    # Don't hash known hosts - it doesn't really add much security since
    # most hosts are also listed in this file and/or Bash history
    HashKnownHosts no

    # Reuse connections
    ControlMaster auto
    ControlPath ~/.ssh/control-master-%r@%h:%p
    ControlPersist 10s

# Note: This must use "Match final" as well, else it overrides the groups above
Match final host *
    ForwardAgent no
    IdentitiesOnly yes
    IdentityFile ~/.ssh/d13r.pub
